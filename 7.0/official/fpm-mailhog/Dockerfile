FROM    php:7.0-fpm

LABEL   maintainer="Mage2click"

RUN     apt-get update && apt-get install -y \
            cron \
            git \
            gzip \
            libfreetype6-dev \
            libicu-dev \
            libjpeg62-turbo-dev \
            libmcrypt-dev \
            libpng-dev \
            libxslt1-dev \
            lsof \
            mysql-client \
            vim \
            zip \
            procps

RUN     docker-php-ext-configure \
            gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/

RUN     docker-php-ext-install \
            bcmath \
            gd \
            intl \
            mbstring \
            mcrypt \
            opcache \
            pcntl \
            sockets \
            pdo_mysql \
            soap \
            xsl \
            zip
  
RUN     pecl channel-update pecl.php.net \
            && pecl install xdebug \
            && docker-php-ext-enable xdebug

RUN     apt-get install -y libssh2-1-dev \
            && pecl install ssh2-1.1.2 \
            && docker-php-ext-enable ssh2

RUN     curl -sS https://getcomposer.org/installer | \
            php -- --install-dir=/usr/local/bin --filename=composer

RUN     groupadd -g 1000 app \
            && useradd -g 1000 -u 1000 -d /var/www -s /bin/bash app

RUN     apt-get install -y gnupg \
            && curl -sL https://deb.nodesource.com/setup_8.x | bash - \
            && apt-get install -y nodejs \
            && mkdir /var/www/.config /var/www/.npm \
            && chown app:app /var/www/.config /var/www/.npm \
            && ln -s /var/www/html/node_modules/grunt/bin/grunt /usr/bin/grunt

RUN     apt-get -y install golang-go \
           && mkdir /opt/go \
           && export GOPATH=/opt/go \
           && go get github.com/mailhog/mhsendmail

RUN     apt-get install -y librabbitmq-dev \
            && pecl install amqp \
            && docker-php-ext-enable amqp

RUN     printf '* *\t* * *\tapp\t%s/usr/local/bin/php /var/www/html/update/cron.php\n' >> /etc/crontab
RUN     printf '* *\t* * *\tapp\t%s/usr/local/bin/php /var/www/html/bin/magento cron:run\n' >> /etc/crontab
RUN     printf '* *\t* * *\tapp\t%s/usr/local/bin/php /var/www/html/bin/magento setup:cron:run\n#\n' >> /etc/crontab

COPY    conf/www.conf /usr/local/etc/php-fpm.d/
COPY    conf/php.ini /usr/local/etc/php/
COPY    conf/php-fpm.conf /usr/local/etc/
COPY    bin/cronstart /usr/local/bin/

RUN     mkdir /sock
RUN     chown -R app:app /usr/local/etc/php/conf.d /sock

USER    app:app

VOLUME  /var/www

WORKDIR /var/www/html